<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SKRC wav â†’ ogg ä¸€æ‹¬å¤‰æ›ãƒ„ãƒ¼ãƒ«ã€Androidå®Œå…¨å®‰å®šç‰ˆã€‘</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body {
  background:#111;
  color:#eee;
  font-family:sans-serif;
  padding:20px;
}
button {
  padding:10px 20px;
  font-size:16px;
}
#log {
  white-space:pre-line;
  margin-top:15px;
  font-size:14px;
}
</style>
</head>

<body>
<h2>SKRC wav â†’ ogg ä¸€æ‹¬å¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼ˆAndroidå®Œå…¨å®‰å®šç‰ˆï¼‰</h2>

<input type="file" id="zip" accept=".zip"><br><br>
<button onclick="start()">å¤‰æ›é–‹å§‹</button>

<div id="log"></div>

<script>
function log(t){
  document.getElementById("log").textContent += t + "\n";
}
const sleep = ms => new Promise(r => setTimeout(r, ms));

let audioCtx = null;

// â˜… wav â†’ oggï¼ˆAndroidæœ€å®‰å®šæ§‹æˆï¼‰
async function wavToOgg(blob){
  if(!audioCtx){
    audioCtx = new AudioContext();
    await audioCtx.resume();
  }

  const buf = await blob.arrayBuffer();
  const buffer = await audioCtx.decodeAudioData(buf);

  const dest = audioCtx.createMediaStreamDestination();
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(dest);

  const recorder = new MediaRecorder(dest.stream, { mimeType:"audio/ogg" });
  const chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.start();
  src.start();

  // ğŸ”¥ Androidå¯¾ç­–ï¼šå†ç”Ÿæ™‚é–“ + 50ms ã§å¼·åˆ¶ stop
  setTimeout(() => {
    if(recorder.state !== "inactive"){
      recorder.stop();
    }
  }, buffer.duration * 1000 + 50);

  await new Promise(r => recorder.onstop = r);

  return new Blob(chunks, { type:"audio/ogg" });
}

async function start(){
  document.getElementById("log").textContent = "";

  const file = document.getElementById("zip").files[0];
  if(!file){
    log("âŒ zipãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  log("zip èª­ã¿è¾¼ã¿ä¸­â€¦");
  const zip = await JSZip.loadAsync(file);
  const out = new JSZip();

  let count = 0;

  for(const name of Object.keys(zip.files)){
    if(!name.endsWith(".wav")) continue;

    count++;
    log(`å¤‰æ›ä¸­: ${name}`);

    const wav = await zip.files[name].async("blob");
    const ogg = await wavToOgg(wav);
    out.file(name.replace(".wav",".ogg"), ogg);

    await sleep(100); // â˜… å®‰å®šç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
  }

  if(count === 0){
    log("âŒ wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  log("zipç”Ÿæˆä¸­â€¦");
  const blob = await out.generateAsync({ type:"blob" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "SKRC_ogg_converted.zip";
  a.click();

  log("âœ… å®Œäº†ï¼ï¼å…¨ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›æˆåŠŸï¼ï¼");
}
</script>
</body>
</html>
